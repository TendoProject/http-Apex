"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EntityProvider = void 0;
const app = require("..");
class EntityProvider {
    constructor() {
        this.createEntities = new Map();
        this.deleteEntities = new Map();
        this.livingEntities = new Map();
        this.lookupEntities = new Map();
        this.releasedIds = [];
        this.nextId = 0;
    }
    create(entity) {
        const id = this.releasedIds.pop();
        if (typeof id !== 'undefined') {
            this.createEntities.set(id, entity);
            this.lookupEntities.set(entity, id);
        }
        else {
            const id = this.nextId;
            this.createEntities.set(id, entity);
            this.lookupEntities.set(entity, id);
            this.nextId++;
        }
    }
    delete(entity) {
        const id = this.lookupEntities.get(entity);
        if (typeof id === 'undefined') {
            throw new Error();
        }
        else if (this.createEntities.has(id)) {
            this.createEntities.delete(id);
            this.lookupEntities.delete(entity);
        }
        else if (this.livingEntities.has(id)) {
            this.deleteEntities.set(id, entity);
            this.livingEntities.delete(id);
            this.lookupEntities.delete(entity);
        }
    }
    receive(packet) {
        if (packet instanceof app.EntityUpdate) {
            this.receiveUpdate(packet);
        }
        else {
            this.receiveSync(packet);
        }
    }
    update(stream, syncId) {
        for (const id of this.deleteEntities.keys()) {
            const packet = new app.EntityDelete(id);
            this.deleteEntities.delete(id);
            this.releasedIds.push(id);
            packet.write(stream);
        }
        for (const [id, entity] of this.createEntities) {
            const packet = new app.EntityCreate(id, entity.address, convertMembers(entity.members), Boolean(entity.options?.requestBatch));
            this.createEntities.delete(id);
            this.livingEntities.set(id, entity);
            packet.write(stream);
        }
        for (const [id, entity] of this.livingEntities) {
            if (!entity.options || !entity.options.enableUpdate)
                continue;
            const packet = entity.update(id, syncId);
            if (!packet)
                continue;
            packet.write(stream);
        }
    }
    receiveUpdate(packet) {
        for (const child of packet.entities) {
            const entity = this.livingEntities.get(child.id);
            if (!entity)
                continue;
            entity.receive(child);
        }
    }
    receiveSync(packet) {
        for (const entity of this.livingEntities.values()) {
            if (!entity.options || !entity.options.enableUpdate)
                continue;
            entity.receive(packet);
        }
    }
}
exports.EntityProvider = EntityProvider;
function convertMembers(members) {
    const result = [];
    for (const [id, member] of members)
        result.push(new app.EntityCreateMember(id, member.interval, member.buffer.byteLength));
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRW50aXR5UHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2FwaS9wcm92aWRlcnMvRW50aXR5UHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMEJBQTBCO0FBRTFCLE1BQWEsY0FBYztJQUEzQjtRQUNtQixtQkFBYyxHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQy9DLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQXNCLENBQUM7UUFDL0MsbUJBQWMsR0FBRyxJQUFJLEdBQUcsRUFBc0IsQ0FBQztRQUMvQyxtQkFBYyxHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQy9DLGdCQUFXLEdBQWtCLEVBQUUsQ0FBQztRQUN6QyxXQUFNLEdBQUcsQ0FBQyxDQUFDO0lBd0VyQixDQUFDO0lBdEVDLE1BQU0sQ0FBQyxNQUFrQjtRQUN2QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksT0FBTyxFQUFFLEtBQUssV0FBVyxFQUFFO1lBQzdCLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7U0FDckM7YUFBTTtZQUNMLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDdkIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDZjtJQUNILENBQUM7SUFFRCxNQUFNLENBQUMsTUFBa0I7UUFDdkIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDM0MsSUFBSSxPQUFPLEVBQUUsS0FBSyxXQUFXLEVBQUU7WUFDN0IsTUFBTSxJQUFJLEtBQUssRUFBRSxDQUFDO1NBQ25CO2FBQU0sSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUN0QyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMvQixJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNwQzthQUFNLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDdEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQztJQUVELE9BQU8sQ0FBQyxNQUF3QztRQUM5QyxJQUFJLE1BQU0sWUFBWSxHQUFHLENBQUMsWUFBWSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDNUI7YUFBTTtZQUNMLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDMUI7SUFDSCxDQUFDO0lBRUQsTUFBTSxDQUFDLE1BQXdCLEVBQUUsTUFBYztRQUM3QyxLQUFLLE1BQU0sRUFBRSxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDM0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3hDLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDdEI7UUFDRCxLQUFLLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUM5QyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsY0FBYyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQy9ILElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3RCO1FBQ0QsS0FBSyxNQUFNLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDOUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFlBQVk7Z0JBQUUsU0FBUztZQUM5RCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsTUFBTTtnQkFBRSxTQUFTO1lBQ3RCLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDdEI7SUFDSCxDQUFDO0lBRU8sYUFBYSxDQUFDLE1BQXdCO1FBQzVDLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxDQUFDLFFBQVEsRUFBRTtZQUNuQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLE1BQU07Z0JBQUUsU0FBUztZQUN0QixNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3ZCO0lBQ0gsQ0FBQztJQUVPLFdBQVcsQ0FBQyxNQUFxQjtRQUN2QyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDakQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFlBQVk7Z0JBQUUsU0FBUztZQUM5RCxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3hCO0lBQ0gsQ0FBQztDQUNGO0FBOUVELHdDQThFQztBQUVELFNBQVMsY0FBYyxDQUFDLE9BQXNDO0lBQzVELE1BQU0sTUFBTSxHQUFrQyxFQUFFLENBQUM7SUFDakQsS0FBSyxNQUFNLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxJQUFJLE9BQU87UUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUMzSCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXBwIGZyb20gJy4uJztcblxuZXhwb3J0IGNsYXNzIEVudGl0eVByb3ZpZGVyIGltcGxlbWVudHMgYXBwLklQYWNrZXRQcm92aWRlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY3JlYXRlRW50aXRpZXMgPSBuZXcgTWFwPG51bWJlciwgYXBwLkVudGl0eT4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBkZWxldGVFbnRpdGllcyA9IG5ldyBNYXA8bnVtYmVyLCBhcHAuRW50aXR5PigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGxpdmluZ0VudGl0aWVzID0gbmV3IE1hcDxudW1iZXIsIGFwcC5FbnRpdHk+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgbG9va3VwRW50aXRpZXMgPSBuZXcgTWFwPGFwcC5FbnRpdHksIG51bWJlcj4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSByZWxlYXNlZElkczogQXJyYXk8bnVtYmVyPiA9IFtdO1xuICBwcml2YXRlIG5leHRJZCA9IDA7XG5cbiAgY3JlYXRlKGVudGl0eTogYXBwLkVudGl0eSkge1xuICAgIGNvbnN0IGlkID0gdGhpcy5yZWxlYXNlZElkcy5wb3AoKTtcbiAgICBpZiAodHlwZW9mIGlkICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5jcmVhdGVFbnRpdGllcy5zZXQoaWQsIGVudGl0eSk7XG4gICAgICB0aGlzLmxvb2t1cEVudGl0aWVzLnNldChlbnRpdHksIGlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLm5leHRJZDtcbiAgICAgIHRoaXMuY3JlYXRlRW50aXRpZXMuc2V0KGlkLCBlbnRpdHkpO1xuICAgICAgdGhpcy5sb29rdXBFbnRpdGllcy5zZXQoZW50aXR5LCBpZCk7XG4gICAgICB0aGlzLm5leHRJZCsrO1xuICAgIH1cbiAgfVxuXG4gIGRlbGV0ZShlbnRpdHk6IGFwcC5FbnRpdHkpIHtcbiAgICBjb25zdCBpZCA9IHRoaXMubG9va3VwRW50aXRpZXMuZ2V0KGVudGl0eSk7XG4gICAgaWYgKHR5cGVvZiBpZCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5jcmVhdGVFbnRpdGllcy5oYXMoaWQpKSB7XG4gICAgICB0aGlzLmNyZWF0ZUVudGl0aWVzLmRlbGV0ZShpZCk7XG4gICAgICB0aGlzLmxvb2t1cEVudGl0aWVzLmRlbGV0ZShlbnRpdHkpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5saXZpbmdFbnRpdGllcy5oYXMoaWQpKSB7XG4gICAgICB0aGlzLmRlbGV0ZUVudGl0aWVzLnNldChpZCwgZW50aXR5KTtcbiAgICAgIHRoaXMubGl2aW5nRW50aXRpZXMuZGVsZXRlKGlkKTtcbiAgICAgIHRoaXMubG9va3VwRW50aXRpZXMuZGVsZXRlKGVudGl0eSk7XG4gICAgfVxuICB9XG5cbiAgcmVjZWl2ZShwYWNrZXQ6IGFwcC5CYXNpY1N5bmMgfCBhcHAuRW50aXR5VXBkYXRlKSB7XG4gICAgaWYgKHBhY2tldCBpbnN0YW5jZW9mIGFwcC5FbnRpdHlVcGRhdGUpIHtcbiAgICAgIHRoaXMucmVjZWl2ZVVwZGF0ZShwYWNrZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlY2VpdmVTeW5jKHBhY2tldCk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlKHN0cmVhbTogYXBwLkJpbmFyeVdyaXRlciwgc3luY0lkOiBudW1iZXIpIHtcbiAgICBmb3IgKGNvbnN0IGlkIG9mIHRoaXMuZGVsZXRlRW50aXRpZXMua2V5cygpKSB7XG4gICAgICBjb25zdCBwYWNrZXQgPSBuZXcgYXBwLkVudGl0eURlbGV0ZShpZCk7XG4gICAgICB0aGlzLmRlbGV0ZUVudGl0aWVzLmRlbGV0ZShpZCk7XG4gICAgICB0aGlzLnJlbGVhc2VkSWRzLnB1c2goaWQpO1xuICAgICAgcGFja2V0LndyaXRlKHN0cmVhbSk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgW2lkLCBlbnRpdHldIG9mIHRoaXMuY3JlYXRlRW50aXRpZXMpIHtcbiAgICAgIGNvbnN0IHBhY2tldCA9IG5ldyBhcHAuRW50aXR5Q3JlYXRlKGlkLCBlbnRpdHkuYWRkcmVzcywgY29udmVydE1lbWJlcnMoZW50aXR5Lm1lbWJlcnMpLCBCb29sZWFuKGVudGl0eS5vcHRpb25zPy5yZXF1ZXN0QmF0Y2gpKTtcbiAgICAgIHRoaXMuY3JlYXRlRW50aXRpZXMuZGVsZXRlKGlkKTtcbiAgICAgIHRoaXMubGl2aW5nRW50aXRpZXMuc2V0KGlkLCBlbnRpdHkpO1xuICAgICAgcGFja2V0LndyaXRlKHN0cmVhbSk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgW2lkLCBlbnRpdHldIG9mIHRoaXMubGl2aW5nRW50aXRpZXMpIHtcbiAgICAgIGlmICghZW50aXR5Lm9wdGlvbnMgfHwgIWVudGl0eS5vcHRpb25zLmVuYWJsZVVwZGF0ZSkgY29udGludWU7XG4gICAgICBjb25zdCBwYWNrZXQgPSBlbnRpdHkudXBkYXRlKGlkLCBzeW5jSWQpO1xuICAgICAgaWYgKCFwYWNrZXQpIGNvbnRpbnVlO1xuICAgICAgcGFja2V0LndyaXRlKHN0cmVhbSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZWNlaXZlVXBkYXRlKHBhY2tldDogYXBwLkVudGl0eVVwZGF0ZSkge1xuICAgIGZvciAoY29uc3QgY2hpbGQgb2YgcGFja2V0LmVudGl0aWVzKSB7XG4gICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmxpdmluZ0VudGl0aWVzLmdldChjaGlsZC5pZCk7XG4gICAgICBpZiAoIWVudGl0eSkgY29udGludWU7XG4gICAgICBlbnRpdHkucmVjZWl2ZShjaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZWNlaXZlU3luYyhwYWNrZXQ6IGFwcC5CYXNpY1N5bmMpIHtcbiAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiB0aGlzLmxpdmluZ0VudGl0aWVzLnZhbHVlcygpKSB7XG4gICAgICBpZiAoIWVudGl0eS5vcHRpb25zIHx8ICFlbnRpdHkub3B0aW9ucy5lbmFibGVVcGRhdGUpIGNvbnRpbnVlO1xuICAgICAgZW50aXR5LnJlY2VpdmUocGFja2V0KTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gY29udmVydE1lbWJlcnMobWVtYmVyczogTWFwPG51bWJlciwgYXBwLkVudGl0eU1lbWJlcj4pIHtcbiAgY29uc3QgcmVzdWx0OiBBcnJheTxhcHAuRW50aXR5Q3JlYXRlTWVtYmVyPiA9IFtdO1xuICBmb3IgKGNvbnN0IFtpZCwgbWVtYmVyXSBvZiBtZW1iZXJzKSByZXN1bHQucHVzaChuZXcgYXBwLkVudGl0eUNyZWF0ZU1lbWJlcihpZCwgbWVtYmVyLmludGVydmFsLCBtZW1iZXIuYnVmZmVyLmJ5dGVMZW5ndGgpKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdfQ==